// Salt Typhoon - Edge exploitation signals (Citrix NetScaler style)
// MITRE: T1190 - Exploit Public-Facing Application

let SuspiciousUA = dynamic(["python-requests","curl","Wget","sqlmap","Metasploit","Nmap"]);
union isfuzzy=true
    (W3CIISLog
     | where csUserAgent has_any (SuspiciousUA)
     | where csUriStem has_any ("/vpn/","/remote/","/api/")
     | summarize Hits=count(), UAs=make_set(csUserAgent) by SourceIP=cIP, bin(TimeGenerated, 10m)
     | where Hits > 20),
    (CommonSecurityLog
     | where DeviceVendor has_any ("Citrix","NetScaler") or DeviceProduct has_any ("NetScaler","Gateway")
     | where RequestURL has_any ("/vpn/","/cgi/","/oauth/")
     | summarize Hits=count() by SourceIP, bin(TimeGenerated,10m)
     | where Hits > 20)
| project TimeGenerated, SourceIP, Hits
